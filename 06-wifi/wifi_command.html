<!DOCTYPE html>
<html>
  <head>
    <title>Key Up/Down Listener</title>
    <script>
      // Display the key states in HTML
      document.addEventListener("DOMContentLoaded", function () {
        const ws = new WebSocket("ws://10.0.0.197:9090");

        // Variables to store the key states
        var keyUpDown = {
          ArrowLeft: false,
          ArrowUp: false,
          ArrowRight: false,
          ArrowDown: false,
        };

        var connected = false;

        ws.onopen = function () {
          connect = true;
          console.log("Connected");
        };

        ws.onclose = function () {
          connect = false;
          console.log("Closed");
        };

        const isWSConnected = function () {
          return ws && ws.readyState === ws.OPEN;
        };

        // Event listeners
        document.addEventListener("keydown", function (event) {
          console.log("keydown", event);
          keyUpDown[event.key] = true;
        });

        document.addEventListener("keyup", function (event) {
          console.log("keyup", event);
          keyUpDown[event.key] = false;
        });

        const keyStateElems = document.querySelectorAll(".key-state");
        const connectionStateElem = document.getElementById("connection-state");
        const updateDisplay = function () {
          for (var i = 0; i < keyStateElems.length; i++) {
            var div = keyStateElems[i];
            var span = div.querySelector("span");
            var key = span.id;
            span.innerHTML = keyUpDown[key];
          }
          connectionStateElem.innerHTML = isWSConnected()
            ? "Connected"
            : "Disconnected. Wait, or connect robot wifi and refresh the page.";
        };

        const sendCommands = function () {
          if (!isWSConnected()) return;
          var command;

          //
          if (keyUpDown["ArrowUp"]) {
            command = "V200";
          } else if (keyUpDown["ArrowDown"]) {
            command = "V-200";
          } else {
            command = "V0";
          }
          ws.send(command);

          var command;
          if (keyUpDown["ArrowRight"]) {
            command = "T100";
          } else if (keyUpDown["ArrowLeft"]) {
            command = "T-100";
          } else {
            command = "T0";
          }
          ws.send(command);
        };

        setInterval(() => {
          sendCommands();
          updateDisplay();
        }, 50);
      });
    </script>
  </head>
  <body>
    <div class="key-state">Left: <span id="ArrowLeft"></span></div>
    <div class="key-state">Up: <span id="ArrowUp"></span></div>
    <div class="key-state">Right: <span id="ArrowRight"></span></div>
    <div class="key-state">Down: <span id="ArrowDown"></span></div>
    <div><span id="connection-state"></span></div>
  </body>
</html>
