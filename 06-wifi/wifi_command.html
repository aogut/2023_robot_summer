<!DOCTYPE html>
<html>
  <head>
    <title>Key Up/Down Listener</title>
    <script>
      var ws = null;
      function connect() {
        ws = new WebSocket("ws://192.168.4.1:9090");
      }

      // Variables to store the key states
      var keyUpDown = {
        ArrowLeft: 0,
        ArrowUp: 0,
        ArrowRight: 0,
        ArrowDown: 0,
      };

      var connected = false;

      connect();

      ws.onopen = function () {
        connected = true;
        updateDisplay();
        console.log("Connected");
      };

      ws.onclose = function () {
        connected = false;
        updateDisplay();
        console.log("Closed");
      };

      // Event listeners
      document.addEventListener("keydown", function (event) {
        console.log("keydown", event);
        keyUpDown[event.key] = 1;
        updateDisplay();
        if (!ws) return;
        if (event.key === "ArrowLeft") {
          ws.send("T-200");
        } else if (event.key === "ArrowRight") {
          ws.send("T200");
        } else if (event.key === "ArrowUp") {
          ws.send("V200");
        } else if (event.key === "ArrowDown") {
          ws.send("V-200");
        }
      });

      document.addEventListener("keyup", function (event) {
        console.log("keyup", event);
        keyUpDown[event.key] = 0;
        updateDisplay();
        if (!ws) return;
        if (event.key === "ArrowLeft") {
          ws.send("T0");
        } else if (event.key === "ArrowRight") {
          ws.send("T0");
        } else if (event.key === "ArrowUp") {
          ws.send("V0");
        } else if (event.key === "ArrowDown") {
          ws.send("V0");
        }
      });

      const updateDisplay = function () {
        var divs = document.querySelectorAll(".key-state");
        for (var i = 0; i < divs.length; i++) {
          var div = divs[i];
          var span = div.querySelector("span");
          var key = span.id;
          span.innerHTML = keyUpDown[key];
        }
        var connectedSpan = document.getElementById("connected-state");
        connectedSpan.innerHTML = connected
          ? "Connected"
          : "Disconnected. Make sure robot is connected, wait or refresh to try again";
      };

      // Display the key states in HTML
      document.addEventListener("DOMContentLoaded", function () {
        updateDisplay();
      });
    </script>
  </head>
  <body>
    <div class="key-state">Left: <span id="ArrowLeft"></span></div>
    <div class="key-state">Up: <span id="ArrowUp"></span></div>
    <div class="key-state">Right: <span id="ArrowRight"></span></div>
    <div class="key-state">Down: <span id="ArrowDown"></span></div>
    <div><span id="connected-state"></span></div>
  </body>
</html>
